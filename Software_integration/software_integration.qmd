---
title: "All softwares are wrong, but some are useful"
author:   
  - Francisco Cardozo 
  - Eric Brown
institute: 
  - University of Miami
  - University of Miami
date: 2024-02-09
date-format: long
format:
  revealjs: 
    theme: simple
    css: style.css
    logo: "images/umlogo.svg"
    footer: "Advanced Research Methods, Spring 2024"
editor_options: 
  chunk_output_type: console
title-slide-attributes: 
      data-background-color: "#ffe700"
---

## Agenda

-   R and *M*plus
-   Data set
-   Multitrait-Multimethod Matrix
-   Pre-processing
-   CFA

# R and *M*plus {background-color="#ffe700"}

## R and *M*plus

::: columns
::: {.column width="40%"}
**R**

-   Integrate your data, analysis and text
-   Tools for data manipulation
-   Packages
-   Free

:::

::: {.column width="60%"}
***M*plus**

-   Consistent syntax
-   Informative outputs
-   Specialized for SEM models
-   Awesome Blog

:::
:::

## Integrate both

You can use R to generate:

- Data sets to *M*plus format
- Create *M*plus code
- Run *M*plus code
- Read *M*plus outputs

Keep your work on *M*plus and use R to write the report. 

> *M*plus  -> R 

## Before jumping to *M* plus...

*M*plus requires that your data is almost ready for analysis. You can do pre-processing in *M*plus (like filter of computing variables) but it is not the best tool for that work. 

R is great for data pre-processing. 

> R -> *M*plus -> R

## R has packages to do SEM Analysis

- [lavaan](https://lavaan.ugent.be/)
  - CFA  
  - Growth Curves
  - Mediation
  - Multilevel SEM
- [polca](https://dlinzer.github.io/poLCA/)
  - Latent Class Analysis
- [simsem](https://simsem.org/)
  - Simulated Structural Equation Modeling

# Example {background-color="#ffe700"}


## Prevention of alcohol use

::: r-fit-text
We usually measure risk factors by asking students in the schools, but because of Covid, it was impossible.

We wanted to ask while they were at home, but it was extremely complicated because of biases and logistics.

> *What happens if we ask parents?* ðŸ¤”

Is the parent evaluation of the student's risk a good approximation of the student's risk?

What is the correlation between students' and parents' perceptions of risk?
:::

## Data set

The data set contains:

-   Risk and protective factors
-   Parent's and students' perspective



## Community Disorganization (CRCDO)

How much do each of the following statements describe your neighborhood?

```{r message=FALSE, echo=FALSE}
library(readxl)
library(kableExtra)
library(tidyverse)
library(here)
```

```{r}

CRCDO <- read_xlsx(here("software_integration/tables/CRCDO.xlsx"))

CRCDO  |>  
 kable() |>  
 kable_styling("striped", full_width = T, 
               font_size = 22) |>  
 column_spec(1, width = "5em") |>  
 row_spec(0, bold = TRUE, font_size = 26)
```

## Perceived Risks of Drug Use (PRPRD)

How much do you think people risk harming themselves (physically or in other ways) if they...

```{r}

RISK <- read_xlsx(here("software_integration/tables/RISK.xlsx"))

RISK |>   
 kable() |>  
 kable_styling("striped", full_width = F, 
               font_size = 22) |>  
 column_spec(1, width = "5em") |>  
 row_spec(0, bold = TRUE, font_size = 26)
```

## Poor Family Management (FRPFM)

In your family...

```{r}
#02_Concepts_in_meassurement_data_analysis
FM <- read_xlsx(here("software_integration/tables/FM.xlsx"))

FM |>   
 kable() |>  
 kable_styling("striped", full_width = F, 
               font_size = 18) |>  
 column_spec(1, width = "5em") |>  
 row_spec(0, bold = TRUE, font_size = 26)
```

--

# Multitrait-Multimethod Matrix  {background-color="#ffe700"}

*Multimethod*= Parent and Child

*Multitrait* = Community Disorganization, Poor Family Management, and Perceived Risks of Drug Use

```{r libraries, eval=FALSE, message=FALSE, warning=FALSE}
library(tidyverse) # Data wrangling 
library(psych) # alpha function
library(MplusAutomation) # to use *M*plus
library(kableExtra) # make tables pretty
library(GGally) # correlation plots
library(table1) # To tables
```

```{r data, include=FALSE}
#02_Concepts_in_meassurement_data_analysis
dyads <- read.csv(here("software_integration/tables/dyads.csv"), stringsAsFactors = F)

dyads <-  
  dyads |> mutate(answer=case_when(VARNAME=="SAFENH" & answer==1 ~ 4,
                                   VARNAME=="SAFENH" & answer==2 ~ 3,
                                   VARNAME=="SAFENH" & answer==3 ~ 2,
                                   VARNAME=="SAFENH" & answer==4 ~ 1,
                                   FACTORNAME=="FRPFM" & answer==1 ~ 4,
                                   FACTORNAME=="FRPFM" & answer==2 ~ 3,
                                   FACTORNAME=="FRPFM" & answer==3 ~ 2,
                                   FACTORNAME=="FRPFM" & answer==4 ~ 1,
                                   TRUE ~ as.numeric(answer))) |>
  mutate(MEMBER=case_when(MEMBER=="Parent" ~ "P",
                          MEMBER=="Student" ~ "S"))

```



```{r message=FALSE, warning=FALSE}
library(tidyverse) # Data wrangling 
library(psych) # alpha function
library(MplusAutomation) # to use *M*plus
library(kableExtra) # make tables pretty
library(GGally) # correlation plots
library(table1) # To tables
```


## Cronbach's Alpha

```{r alpha, message=FALSE, comment='', echo=FALSE}

library(psych)

# Save items in this objects. I can uses the object to select variables from the big data set.
CR <- dyads |> filter(FACTORNAME == "CRCDO") |>  pull(VARNAME) |> 
  unique()
PR <- dyads |> filter(FACTORNAME == "PRPRD") |>  pull(VARNAME) |> 
  unique()
FR <-  dyads |> filter(FACTORNAME == "FRPFM") |>  pull(VARNAME) |> 
  unique()

alpha_CR <- dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  pivot_wider(names_from = VARNAME , values_from = answer)  |> 
  select(CR) |> (function(x) alpha( x))() |> 
  pluck(1,1)

alpha_PR <-  dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = VARNAME , values_from = answer)  |> 
  select(PR) |> (function(x) alpha( x))() |> 
  pluck(1,1)

alpha_FR <- dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = VARNAME , values_from = answer)  |> 
  select(FR) |> (function(x) alpha( x))() |> 
  pluck(1,1)


```

Community Disorganization = `r round(alpha_CR,3)`

Perceived Risk of Drug Use = `r round(alpha_PR,3)`

Poor Family Management = `r round(alpha_FR,3)`

## Cronbach's Alpha Community Disorganization (CRCDO)

Parent, student

```{r,message=FALSE, echo=FALSE, comment=''}
dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("P_",CR)) |> (function(x) alpha( x))() |> 
  pluck(1,1)

dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("S_",CR)) |> (function(x) alpha( x))() |> 
  pluck(1,1)


```

## Cronbach's Alpha Perceived Risks of Drug Use (PRPRD)

Parent, student

```{r,message=FALSE, echo=FALSE, comment=''}

dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("P_",PR)) |> (function(x) alpha( x))() |> 
  pluck(1,1)

dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("S_",PR)) |> (function(x) alpha( x))() |> 
  pluck(1,1)


```

## Cronbach's Alpha Poor Family Management (FRPFM)

Parent, student

```{r,message=FALSE, echo=FALSE, comment=''}
dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("P_",FR))|> (function(x) alpha( x))() |> 
  pluck(1,1)

dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |>
  select(MEMBER, ID, VARNAME, answer) |> 
  group_by(MEMBER, ID, VARNAME) |> ungroup() |>  
  pivot_wider(names_from = c(MEMBER, VARNAME) , values_from = answer)  |> 
  select(paste0("S_",FR)) |> (function(x) alpha( x))() |> 
  pluck(1,1)
```

## MultiTrait MultiMethod Matrix

```{r, warning=FALSE, echo=FALSE, comment=''}
#| fig-cap: 
#| - "**CRCDO**= Community Disorganization, **PRPRD**= Perceived Risks of Drug Use, **FRPFM**= Poor Family Management"

dyads |> filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |> 
  group_by(MEMBER, ID, FACTORNAME) |>
  summarise(mean= mean(answer)) |> 
  pivot_wider(names_from = c(MEMBER, FACTORNAME) , values_from = mean ) |> 
  ggpairs(columns = 2:7, 
          lower  = list(continuous = "blank"),
             diag  = list(continuous = "blankDiag")) 
```

# Pre-processing {background-color="#ffe700"}

## Data set in wide format

::: {style="font-size: 0.7em"}
You have an ID column, but the participants (unit of analysis) only appear once.
:::

<br>

::: {style="font-size: 0.5em; text-align: center"}
| ID  | Parent_RF1_item1 | Parent_RF1_item2 | Student_RF1_Item1 | Student_RF1_Item2 |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| 1   |        1         |        3         |         2         |         1         |
| 2   |        4         |        2         |         3         |         1         |
:::


## Data set in long format

::: {style="font-size: 0.7em"}
You have ID column, and the participants are repeated multiple times in different rows.
:::

<br>

::: {style="font-size: 0.5em; text-align: center"}
| ID  | Member  | Risk Factor | Item  | Answer | Label |
|-----|---------|-------------|-------|:------:|-------|
| 1   | Parent  | RF1         | Item1 |   2    | no    |
| 1   | Parent  | RF1         | Item2 |   3    | yes   |
| 1   | Student | RF1         | Item1 |   2    | no    |
| 1   | Student | RF1         | Item2 |   1    | YES!  |
| 1   | Parent  | RF2         | Item1 |   4    | NO!   |
| 1   | Parent  | RF2         | Item2 |   2    | no    |
| 1   | Student | RF2         | Item1 |   3    | yes   |
| 1   | Student | RF2         | Item2 |   2    | no    |
| 2   | Parent  | RF1         | Item1 |   4    | NO!   |
| 2   | Parent  | RF1         | Item2 |   2    | yes   |
| 2   | Student | RF1         | Item1 |   3    | no    |
| 2   | Student | RF1         | Item2 |   1    | YES!  |
:::


## Long and wide format

<iframe data-src="tidyr.pdf" width="1000" height="500">

</iframe>

# Click to go to the [Practice](https://francisco-cardozo.shinyapps.io/Pivot/#section-the-data-set) {background-color="#ffe700"}

# `MplusAutomation`

## `MplusAutomation`

A package:

-   Run *M*plus scripts from R.
-   Convert data into *M*plus format.
-   Generate *M*plus scripts
-   Read *M*plus outputs into R
-   Plot model results

## MplusAutomation

```{r install-mpl, echo=TRUE, eval=FALSE}
# 1. Install to save the package in your computer. 
# You only need to do this once
install.packages("MplusAutomation") 

# 2. Call the package to activate the functions saved in the package.
library(MplusAutomation) 
```

<br>

<iframe data-src="MplusAutomation.pdf" width="1100" height="300">

</iframe>

## MplusAutomation

Before you start pivoting your data, begin by...

Import your data

  * [bulkreadr](https://gbganalyst.github.io/bulkreadr/) 
  * [haven](https://github.com/tidyverse/haven) 
  * [readxl](https://readxl.tidyverse.org/) 


```{r import-libraries, echo=TRUE, eval=FALSE}
library(readxl) # To read excel files in R
library(tidyverse) # To activate the "pivot" functions
library(MplusAutomation) # To activate the function "prepareMplusData"

dyads <- read_xlsx("./replace_this_with_the_name_of_your_data_file.xlsx")

```

## MplusAutomation

Reshape data from long to wide format. 

```{r, echo=TRUE, "code-line-numbers"="2-7"}

# Pivot wider your data
Mplus_dyads <- 
  dyads |> 
  filter(FACTORNAME %in% c("CRCDO", "PRPRD", "FRPFM")) |> 
  select(ID, MEMBER, VARNAME, answer) |> 
  pivot_wider(names_from = c(MEMBER, VARNAME),
              values_from = answer) 

Mplus_dyads |> head(2) |> gt::gt()



```

## MplusAutomation

Recode missing data 

```{r, echo=TRUE, eval=FALSE, "code-line-numbers"="9-10"}

# Define missing data value
Mplus_dyads[is.na(Mplus_dyads)] <- 999

```

And export

```{r echo=TRUE, eval=FALSE}
# Export your data to Mplus
prepareMplusData(Mplus_dyads, "Mplus_dyads.dat")

```

## MplusAutomation

::: columns
::: {.column width="50%"}
![](images/console.png)
:::

::: {.column width="50%"}
![](images/datafile.png){width="\"80%"}
:::
:::

# Practice {background-color="#ffe700"}


# CFA in R using `Lavaan`

```{r, message=FALSE, warning=FALSE}
Mplus_cfa <- dyads |> 
  select(ID, MEMBER, answer, VARNAME) |> 
  filter(VARNAME %in% c("HMALC", "HMCIG", "HMMARO", "HMMARR")) |> 
  pivot_wider(id_cols=c(ID, MEMBER), names_from = VARNAME, values_from=answer) |> 
  select(-ID, -MEMBER)
```

## CFA Lavaan

To estimate the model you need to

1. use `library(lavaan)`
2. Specify your model

Perceived Risks of Drug Use (PRPRD) by items HMALC, HMCIG, HMMARO and HMMARR.

```{r,comment='', echo=TRUE}
library(lavaan)

model  <- '

PRPRD =~ HMALC  + HMCIG + HMMARO + HMMARR

'
```


## CFA Lavaan

To estimate the model you need to

3. Estimate your model  

```{r,  comment='', echo=TRUE}

# Entire sample
cfa_fit <- cfa(model, data=Mplus_cfa) 

cfa_results <- summary(cfa_fit, standardized=TRUE, fit.measures=TRUE) 

```

The standardized argument equal TRUE gives you results equivalent to STD (Std.lv) and STDYX (Std.all) on Mplus. 

You can have reduced output using `standardizedsolution()`

## lavaan ouput

```{r}
cfa_results
```

## lavaan ouput

```{r}
# Notice that the object is the fit of the model, not the summary.
standardizedsolution(cfa_fit)
```

##

```{r}
library(gtExtras)
# Notice that the object is the fit of the model, not the summary.
standardizedsolution(cfa_fit) |> gt() |> fmt_number(
    decimals = 3,
    use_seps = FALSE
  ) |> 
   tab_header(
    title = "My First CFA in R",
    subtitle = "Advanced Research Methods"
  ) |> gt_theme_nytimes()
  
```


# Practice {background-color="#ffe700" }

# CFA by groups {background-color="#ffe700" }

## Parents

```{r, comment='', echo=TRUE}
parents <-dyads |> filter(MEMBER=="P") |> 
  select(ID, answer, VARNAME) |> 
  filter(VARNAME %in% c("HMALC", "HMCIG", "HMMARO", "HMMARR")) |> 
  pivot_wider(names_from = VARNAME, values_from=answer, id_cols = ID) |> 
  select(-ID)

parents_results <- cfa(model, data=parents)  |> 
  summary(standardized=TRUE, fit.measures=TRUE)

```

## Parents

```{r}
parents_results
```


## Students

```{r, comment='', echo=TRUE}
students <-dyads |> filter(MEMBER=="S") |> 
  select(ID, answer, VARNAME) |> 
  filter(VARNAME %in% c("HMALC", "HMCIG", "HMMARO", "HMMARR")) |> 
  pivot_wider(names_from = VARNAME, values_from=answer, id_cols = ID) |> 
  select(-ID)

students_results <- cfa(model, data=students)  |> 
  summary(standardized=TRUE, fit.measures=TRUE)

```


## Students

```{r}
students_results
```


# We can do better {background-color="#ffe700" }

Are we measuring the same thing? 
Invariance?
Dyads?

# The end
